var we=Object.create;var z=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Pe=Object.getOwnPropertyNames;var qe=Object.getPrototypeOf,Ue=Object.prototype.hasOwnProperty;var d=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var Ne=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of Pe(r))!Ue.call(e,n)&&n!==t&&z(e,n,{get:()=>r[n],enumerable:!(s=Oe(r,n))||s.enumerable});return e};var y=(e,r,t)=>(t=e!=null?we(qe(e)):{},Ne(r||!e||!e.__esModule?z(t,"default",{value:e,enumerable:!0}):t,e));var F=d(C=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0});C.default=be;var De=Ae(require("crypto"));function Ae(e){return e&&e.__esModule?e:{default:e}}var T=new Uint8Array(256),h=T.length;function be(){return h>T.length-16&&(De.default.randomFillSync(T),h=0),T.slice(h,h+=16)}});var Q=d(M=>{"use strict";Object.defineProperty(M,"__esModule",{value:!0});M.default=void 0;var He=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;M.default=He});var E=d(w=>{"use strict";Object.defineProperty(w,"__esModule",{value:!0});w.default=void 0;var Le=ke(Q());function ke(e){return e&&e.__esModule?e:{default:e}}function Be(e){return typeof e=="string"&&Le.default.test(e)}var Ce=Be;w.default=Ce});var S=d(O=>{"use strict";Object.defineProperty(O,"__esModule",{value:!0});O.default=void 0;var Fe=Xe(E());function Xe(e){return e&&e.__esModule?e:{default:e}}var o=[];for(let e=0;e<256;++e)o.push((e+256).toString(16).substr(1));function Ge(e,r=0){let t=(o[e[r+0]]+o[e[r+1]]+o[e[r+2]]+o[e[r+3]]+"-"+o[e[r+4]]+o[e[r+5]]+"-"+o[e[r+6]]+o[e[r+7]]+"-"+o[e[r+8]]+o[e[r+9]]+"-"+o[e[r+10]]+o[e[r+11]]+o[e[r+12]]+o[e[r+13]]+o[e[r+14]]+o[e[r+15]]).toLowerCase();if(!(0,Fe.default)(t))throw TypeError("Stringified UUID is invalid");return t}var We=Ge;O.default=We});var ee=d(P=>{"use strict";Object.defineProperty(P,"__esModule",{value:!0});P.default=void 0;var $e=j(F()),Ve=j(S());function j(e){return e&&e.__esModule?e:{default:e}}var Z,X,G=0,W=0;function Ye(e,r,t){let s=r&&t||0,n=r||new Array(16);e=e||{};let u=e.node||Z,i=e.clockseq!==void 0?e.clockseq:X;if(u==null||i==null){let l=e.random||(e.rng||$e.default)();u==null&&(u=Z=[l[0]|1,l[1],l[2],l[3],l[4],l[5]]),i==null&&(i=X=(l[6]<<8|l[7])&16383)}let f=e.msecs!==void 0?e.msecs:Date.now(),a=e.nsecs!==void 0?e.nsecs:W+1,m=f-G+(a-W)/1e4;if(m<0&&e.clockseq===void 0&&(i=i+1&16383),(m<0||f>G)&&e.nsecs===void 0&&(a=0),a>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");G=f,W=a,X=i,f+=122192928e5;let g=((f&268435455)*1e4+a)%4294967296;n[s++]=g>>>24&255,n[s++]=g>>>16&255,n[s++]=g>>>8&255,n[s++]=g&255;let R=f/4294967296*1e4&268435455;n[s++]=R>>>8&255,n[s++]=R&255,n[s++]=R>>>24&15|16,n[s++]=R>>>16&255,n[s++]=i>>>8|128,n[s++]=i&255;for(let l=0;l<6;++l)n[s+l]=u[l];return r||(0,Ve.default)(n)}var Ke=Ye;P.default=Ke});var $=d(q=>{"use strict";Object.defineProperty(q,"__esModule",{value:!0});q.default=void 0;var ze=Je(E());function Je(e){return e&&e.__esModule?e:{default:e}}function Qe(e){if(!(0,ze.default)(e))throw TypeError("Invalid UUID");let r,t=new Uint8Array(16);return t[0]=(r=parseInt(e.slice(0,8),16))>>>24,t[1]=r>>>16&255,t[2]=r>>>8&255,t[3]=r&255,t[4]=(r=parseInt(e.slice(9,13),16))>>>8,t[5]=r&255,t[6]=(r=parseInt(e.slice(14,18),16))>>>8,t[7]=r&255,t[8]=(r=parseInt(e.slice(19,23),16))>>>8,t[9]=r&255,t[10]=(r=parseInt(e.slice(24,36),16))/1099511627776&255,t[11]=r/4294967296&255,t[12]=r>>>24&255,t[13]=r>>>16&255,t[14]=r>>>8&255,t[15]=r&255,t}var Ze=Qe;q.default=Ze});var V=d(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});I.default=tr;I.URL=I.DNS=void 0;var je=re(S()),er=re($());function re(e){return e&&e.__esModule?e:{default:e}}function rr(e){e=unescape(encodeURIComponent(e));let r=[];for(let t=0;t<e.length;++t)r.push(e.charCodeAt(t));return r}var te="6ba7b810-9dad-11d1-80b4-00c04fd430c8";I.DNS=te;var se="6ba7b811-9dad-11d1-80b4-00c04fd430c8";I.URL=se;function tr(e,r,t){function s(n,u,i,f){if(typeof n=="string"&&(n=rr(n)),typeof u=="string"&&(u=(0,er.default)(u)),u.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let a=new Uint8Array(16+n.length);if(a.set(u),a.set(n,u.length),a=t(a),a[6]=a[6]&15|r,a[8]=a[8]&63|128,i){f=f||0;for(let m=0;m<16;++m)i[f+m]=a[m];return i}return(0,je.default)(a)}try{s.name=e}catch{}return s.DNS=te,s.URL=se,s}});var ne=d(U=>{"use strict";Object.defineProperty(U,"__esModule",{value:!0});U.default=void 0;var sr=nr(require("crypto"));function nr(e){return e&&e.__esModule?e:{default:e}}function ur(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),sr.default.createHash("md5").update(e).digest()}var ar=ur;U.default=ar});var ae=d(N=>{"use strict";Object.defineProperty(N,"__esModule",{value:!0});N.default=void 0;var or=ue(V()),ir=ue(ne());function ue(e){return e&&e.__esModule?e:{default:e}}var dr=(0,or.default)("v3",48,ir.default),fr=dr;N.default=fr});var ie=d(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});D.default=void 0;var lr=oe(F()),cr=oe(S());function oe(e){return e&&e.__esModule?e:{default:e}}function pr(e,r,t){e=e||{};let s=e.random||(e.rng||lr.default)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,r){t=t||0;for(let n=0;n<16;++n)r[t+n]=s[n];return r}return(0,cr.default)(s)}var mr=pr;D.default=mr});var de=d(A=>{"use strict";Object.defineProperty(A,"__esModule",{value:!0});A.default=void 0;var vr=_r(require("crypto"));function _r(e){return e&&e.__esModule?e:{default:e}}function gr(e){return Array.isArray(e)?e=Buffer.from(e):typeof e=="string"&&(e=Buffer.from(e,"utf8")),vr.default.createHash("sha1").update(e).digest()}var yr=gr;A.default=yr});var le=d(b=>{"use strict";Object.defineProperty(b,"__esModule",{value:!0});b.default=void 0;var Ir=fe(V()),xr=fe(de());function fe(e){return e&&e.__esModule?e:{default:e}}var Rr=(0,Ir.default)("v5",80,xr.default),Er=Rr;b.default=Er});var ce=d(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.default=void 0;var Sr="00000000-0000-0000-0000-000000000000";H.default=Sr});var pe=d(L=>{"use strict";Object.defineProperty(L,"__esModule",{value:!0});L.default=void 0;var hr=Tr(E());function Tr(e){return e&&e.__esModule?e:{default:e}}function Mr(e){if(!(0,hr.default)(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)}var wr=Mr;L.default=wr});var me=d(p=>{"use strict";Object.defineProperty(p,"__esModule",{value:!0});Object.defineProperty(p,"v1",{enumerable:!0,get:function(){return Or.default}});Object.defineProperty(p,"v3",{enumerable:!0,get:function(){return Pr.default}});Object.defineProperty(p,"v4",{enumerable:!0,get:function(){return qr.default}});Object.defineProperty(p,"v5",{enumerable:!0,get:function(){return Ur.default}});Object.defineProperty(p,"NIL",{enumerable:!0,get:function(){return Nr.default}});Object.defineProperty(p,"version",{enumerable:!0,get:function(){return Dr.default}});Object.defineProperty(p,"validate",{enumerable:!0,get:function(){return Ar.default}});Object.defineProperty(p,"stringify",{enumerable:!0,get:function(){return br.default}});Object.defineProperty(p,"parse",{enumerable:!0,get:function(){return Hr.default}});var Or=_(ee()),Pr=_(ae()),qr=_(ie()),Ur=_(le()),Nr=_(ce()),Dr=_(pe()),Ar=_(E()),br=_(S()),Hr=_($());function _(e){return e&&e.__esModule?e:{default:e}}});var Ot=require("dotenv/config"),Me=y(require("node-color-log")),Y=y(require("express"));var B=require("express");var _e=require("jsonschema");var J=y(require("better-sqlite3")),c=new J.default("database.db");c.pragma("journal_mode = WAL");c.prepare("CREATE TABLE IF NOT EXISTS users (userId INTEGER PRIMARY KEY, username TEXT, password TEXT);").run();c.prepare("CREATE TABLE IF NOT EXISTS sessions (userId INTEGER, sessionId TEXT, userAgent TEXT, expiry TIME);").run();c.prepare("CREATE TABLE IF NOT EXISTS messages (userId INTEGER, message TEXT, isFile BOOL);").run();var ge=y(require("bcrypt"));var v=y(me(),1),tt=v.default.v1,st=v.default.v3,ve=v.default.v4,nt=v.default.v5,ut=v.default.NIL,at=v.default.version,ot=v.default.validate,it=v.default.stringify,dt=v.default.parse;function k(e,r,t){let s=ve(),n=e.headers["user-agent"];r.setHeader("Set-Cookie",[`__Secure-sessionId=${s}; Secure; HttpOnly; SameSite=Strict; Path=/api`]);let u=new Date;u.setMinutes(u.getMinutes()+30),c.prepare("INSERT INTO sessions(userId,sessionId, userAgent, expiry) VALUES(?, ?, ?, ?);").run(t,s,n,u.toISOString()),r.sendStatus(200)}var Lr={type:"object",properties:{username:{type:"string"},password:{type:"string"}},required:["username","password"],additionalProperties:!1},ye=function(e,r){console.log(e.body),console.debug(e.body);let t=(0,_e.validate)(e.body,Lr).errors.map(i=>i.message);if(t.length){r.status(422).send({errors:t});return}let s=e.body,n=c.prepare("SELECT password, userId FROM users WHERE username=?").get(s.username);if(!n){r.status(401).send({errors:["Username amd/or Password is not valid"]});return}if(!ge.default.compare(s.password,n.password)){r.status(401).send({errors:["Username amd/or Password is not valid"]});return}k(e,r,n.userId)};var Ie=function(e,r){var u;let t=(u=e.cookies)==null?void 0:u["__Secure-sessionId"];if(console.debug(e.headers),console.debug(e.cookies),console.log(t),!t){r.status(401).send({errors:["Session ID Not Found"]});return}let s=new Date;s.setMinutes(s.getMinutes()+30);let n=c.prepare("UPDATE sessions SET expiry=? WHERE sessionId=? RETURNING userId").get(s.toISOString(),t);if(!n){r.status(401).send({errors:["Invalid Session ID"]});return}return n.userId};var xe=async function(e,r){!Ie(e,r)||r.sendStatus(200)};var Re=require("jsonschema"),Ee=y(require("bcrypt"));var kr={type:"object",properties:{username:{type:"string"},password:{type:"string"}},required:["username","password"],additionalProperties:!1},Se=async function(e,r){var f,a,m,g;let t=(0,Re.validate)(e==null?void 0:e.body,kr).errors.map(R=>R.message);if(((a=(f=e==null?void 0:e.body)==null?void 0:f.username)==null?void 0:a.length)<=5&&t.push("username must be longer then 5 characters"),((g=(m=e==null?void 0:e.body)==null?void 0:m.password)==null?void 0:g.length)<=8&&t.push("password must be longer then 8 characters"),t.length){r.status(422).send({errors:t});return}let s=e.body;if(c.prepare("SELECT EXISTS(SELECT 1 FROM users WHERE username=? LIMIT 1);").pluck().get(s.username)!=0){r.status(409).send({errors:["Username Taken"]});return}let u=await Ee.default.hash(s.password,10),i=c.prepare("INSERT INTO users(username, password) VALUES(?, ?) RETURNING userId").get(s.username,u).userId;k(e,r,i)};var he=y(require("cookie-parser")),x=(0,B.Router)();x.use((0,he.default)());x.use((0,B.json)());x.post("/auth/login",ye);x.post("/auth/signup",Se);x.post("/newMessage",xe);var K=(0,Y.default)(),Te=process.env.PORT||8080;K.use("/api/",x);K.use(Y.default.static("public"));K.listen(Te,()=>{Me.default.info(`server started at http://localhost:${Te}`)});
//# sourceMappingURL=index.js.map
